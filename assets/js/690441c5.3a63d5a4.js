"use strict";(globalThis.webpackChunkmimoe_devportal=globalThis.webpackChunkmimoe_devportal||[]).push([[5829],{1056(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"ai-foundation/development/create-ai-agent","title":"Create an AI Agent","description":"Build an AI Agent mim with MCP tools using create-mim","source":"@site/docs/ai-foundation/development/create-ai-agent.md","sourceDirName":"ai-foundation/development","slug":"/ai-foundation/development/create-ai-agent","permalink":"/webdemo/docs/ai-foundation/development/create-ai-agent","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Create an AI Agent","description":"Build an AI Agent mim with MCP tools using create-mim"},"sidebar":"aiFoundationSidebar","previous":{"title":"How AI Agent mims Work","permalink":"/webdemo/docs/ai-foundation/development/how-ai-agent-mims-work"}}');var i=t(4848),o=t(8453);const r={sidebar_position:2,title:"Create an AI Agent",description:"Build an AI Agent mim with MCP tools using create-mim"},l="Create an AI Agent",a={},c=[{value:"What You&#39;ll Build",id:"what-youll-build",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Model Requirements for Function Calling",id:"model-requirements-for-function-calling",level:3},{value:"Context Size Requirements",id:"context-size-requirements",level:3},{value:"Step 1: Create the Project",id:"step-1-create-the-project",level:2},{value:"Step 2: Project Structure",id:"step-2-project-structure",level:2},{value:"Step 3: Understanding the Code",id:"step-3-understanding-the-code",level:2},{value:"Entry Point (src/index.js)",id:"entry-point-srcindexjs",level:3},{value:"MCP Tools (src/tools.js)",id:"mcp-tools-srctoolsjs",level:3},{value:"Schema Helpers",id:"schema-helpers",level:4},{value:"Agent Orchestration (src/agent.js)",id:"agent-orchestration-srcagentjs",level:3},{value:"Streaming Events",id:"streaming-events",level:4},{value:"Advanced Configuration",id:"advanced-configuration",level:4},{value:"Step 4: Build the Project",id:"step-4-build-the-project",level:2},{value:"Step 5: Deploy to mimOE",id:"step-5-deploy-to-mimoe",level:2},{value:"Step 6: Test the AI Agent",id:"step-6-test-the-ai-agent",level:2},{value:"Health Check",id:"health-check",level:3},{value:"List MCP Tools",id:"list-mcp-tools",level:3},{value:"Call a Tool Directly",id:"call-a-tool-directly",level:3},{value:"Chat with the Agent",id:"chat-with-the-agent",level:3},{value:"Step 7: Add Custom Tools",id:"step-7-add-custom-tools",level:2},{value:"Step 8: Advanced Security (Optional)",id:"step-8-advanced-security-optional",level:2},{value:"Tool Whitelisting",id:"tool-whitelisting",level:3},{value:"Runtime Tool Approval",id:"runtime-tool-approval",level:3},{value:"Recap: The Four Things You Implemented",id:"recap-the-four-things-you-implemented",level:2},{value:"Serverless Execution",id:"serverless-execution",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Build Fails with Syntax Errors",id:"build-fails-with-syntax-errors",level:3},{value:"Tool Not Found",id:"tool-not-found",level:3},{value:"Agent Returns Empty Response",id:"agent-returns-empty-response",level:3},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"create-an-ai-agent",children:"Create an AI Agent"})}),"\n",(0,i.jsxs)(n.p,{children:["Build an AI Agent that runs on-device with Model Context Protocol (MCP) tools. This tutorial uses ",(0,i.jsx)(n.code,{children:"create-mim"})," to scaffold a complete AI Agent project."]}),"\n",(0,i.jsx)(n.admonition,{title:"New to AI Agent mims?",type:"tip",children:(0,i.jsxs)(n.p,{children:["If you haven't already, read ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"/webdemo/docs/ai-foundation/development/how-ai-agent-mims-work",children:"How AI Agent mims Work"})})," first to understand the architecture and core concepts. This tutorial puts those concepts into practice."]})}),"\n",(0,i.jsx)(n.h2,{id:"what-youll-build",children:"What You'll Build"}),"\n",(0,i.jsx)(n.p,{children:"An AI Agent mim that:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Exposes an MCP server with custom tools"}),"\n",(0,i.jsxs)(n.li,{children:["Uses ",(0,i.jsx)(n.code,{children:"@mimik/agent-kit"})," for AI orchestration"]}),"\n",(0,i.jsx)(n.li,{children:"Streams responses via Server-Sent Events (SSE)"}),"\n",(0,i.jsx)(n.li,{children:"Discovers nearby devices using mimOE's mesh capabilities"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Before starting, ensure you have:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Node.js 18+"})," installed"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"mimOE running"})," with the AI Foundation Addon (see ",(0,i.jsx)(n.a,{href:"/docs/ai-foundation/quick-start",children:"Quick Start"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"A model with tool use support"})," loaded for inference (see below)"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Verify mimOE is running:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl http://localhost:8083/mimik-ai/openai/v1/models \\\n  -H "Authorization: Bearer 1234"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"model-requirements-for-function-calling",children:"Model Requirements for Function Calling"}),"\n",(0,i.jsxs)(n.admonition,{title:"Model Must Support Tool Use",type:"warning",children:[(0,i.jsx)(n.p,{children:"Not all models support function calling (tool use). The model must be specifically trained for tool use capabilities. Models without this training cannot be used for AI Agents that need to call MCP tools."}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Recommended model"}),": Qwen3 (e.g., ",(0,i.jsx)(n.code,{children:"qwen3-1.7b"}),"). It provides both reasoning and tool use support, optimized for on-device inference."]})]}),"\n",(0,i.jsx)(n.h3,{id:"context-size-requirements",children:"Context Size Requirements"}),"\n",(0,i.jsx)(n.p,{children:"Tool use requires a larger context window because the conversation includes tool definitions, tool calls, and tool results. Two settings control this:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"initContextSize"})})," (Model Registry): Total context window size (input + output combined). Set when uploading the model:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "initContextSize": 12000\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["For tool-using agents, 12K+ tokens is recommended. See ",(0,i.jsx)(n.a,{href:"/docs/api/model-registry",children:"Model Registry API"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"max_tokens"})})," (Inference/agent-kit): Maximum tokens to ",(0,i.jsx)(n.strong,{children:"generate"})," in the response. Set in your agent configuration:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"llm: {\n  max_tokens: 4096,  // Maximum output tokens\n  // ... other config\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This limits output length, not total context. See ",(0,i.jsx)(n.a,{href:"/docs/api/inference",children:"Inference API"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"initContextSize"})," is the total budget. Your input (instructions + tool definitions + history) uses part of it, leaving the rest for output. If your input uses 8K tokens and ",(0,i.jsx)(n.code,{children:"initContextSize"})," is 12K, you have 4K tokens available for the response."]})}),"\n",(0,i.jsx)(n.h2,{id:"step-1-create-the-project",children:"Step 1: Create the Project"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"create-mim"})," to scaffold an AI Agent project:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx create-mim create my-agent -t ai-agent\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This creates a ",(0,i.jsx)(n.code,{children:"my-agent/"})," directory with the complete project structure."]}),"\n",(0,i.jsx)(n.p,{children:"Navigate to the project and install dependencies:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd my-agent\nnpm install\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-2-project-structure",children:"Step 2: Project Structure"}),"\n",(0,i.jsx)(n.p,{children:"The generated project contains:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"my-agent/\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 index.js      # Router with /mcp, /healthcheck, /chat endpoints\n\u2502   \u251c\u2500\u2500 agent.js      # AI Agent orchestration\n\u2502   \u2514\u2500\u2500 tools.js      # MCP tools definition\n\u251c\u2500\u2500 config/\n\u2502   \u2514\u2500\u2500 default.yml   # Package configuration\n\u251c\u2500\u2500 test/\n\u2502   \u2514\u2500\u2500 simple.http   # REST client tests\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 webpack.config.js\n\u2514\u2500\u2500 eslint.config.js\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-3-understanding-the-code",children:"Step 3: Understanding the Code"}),"\n",(0,i.jsx)(n.h3,{id:"entry-point-srcindexjs",children:"Entry Point (src/index.js)"}),"\n",(0,i.jsx)(n.p,{children:"The entry point sets up three endpoints with SSE streaming support:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const Router = require('router');\nconst { tools, getMcpEndpoints } = require('./tools');\nconst agent = require('./agent');\n\nlet isHeaderSet = false;\n\nconst sendSSE = (res, data) => {\n  if (!isHeaderSet) {\n    res.statusCode = 200;\n    res.setHeader('content-type', 'text/event-stream');\n    res.setHeader('transfer-encoding', 'chunked');\n    isHeaderSet = true;\n  }\n\n  const message = `data: ${JSON.stringify(data)}\\n\\n`;\n  res.write(message);\n};\n\nconst app = Router();\n\n// MCP protocol handler\napp.post('/mcp', (req, res) => {\n  tools.handleMcpRequest(req.body).then((response) => {\n    if (response) {\n      res.end(JSON.stringify(response));\n    } else {\n      res.statusCode = 204;\n      res.end();\n    }\n  }).catch((error) => {\n    res.statusCode = 500;\n    res.end(JSON.stringify({ error }));\n  });\n});\n\n// Health check\napp.get('/healthcheck', (req, res) => {\n  const { info } = global.context;\n  res.end(JSON.stringify({ status: 'ok', info }));\n});\n\n// Chat endpoint with SSE streaming\napp.post('/chat', async (req, res) => {\n  try {\n    const result = await agent.run(getMcpEndpoints());\n\n    for await (const event of result) {\n      sendSSE(res, event);\n    }\n\n    res.end();\n  } catch (error) {\n    console.error('Agent error:', error);\n    if (isHeaderSet) {\n      sendSSE(res, { error: { message: error.message, type: 'agent_error' } });\n      res.end();\n    } else {\n      res.end(JSON.stringify({ error: { message: error.message, type: 'agent_error' } }));\n    }\n  }\n});\n\nmimikModule.exports = (context, req, res) => {\n  global.context = context;\n  global.http = global.context.http;\n  app(req, res, (e) => {\n    res.end(JSON.stringify({ code: e ? 400 : 404, message: e || 'Not Found' }));\n  });\n};\n"})}),"\n",(0,i.jsx)(n.p,{children:"Key points:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"mimikModule.exports"})," is the mim entry point (not ",(0,i.jsx)(n.code,{children:"module.exports"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"context"})," object provides runtime APIs like ",(0,i.jsx)(n.code,{children:"context.http"})," and ",(0,i.jsx)(n.code,{children:"context.info"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sendSSE"})," helper handles SSE formatting with proper headers"]}),"\n",(0,i.jsx)(n.li,{children:"Error handling for both streaming and non-streaming error responses"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"mcp-tools-srctoolsjs",children:"MCP Tools (src/tools.js)"}),"\n",(0,i.jsxs)(n.admonition,{title:"Why MCP for Local Tools?",type:"info",children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"agent-kit"})," only accepts tool definitions via the MCP protocol. Even for tools defined in the same mim, we use ",(0,i.jsx)(n.code,{children:"mcp-kit"})," to create an MCP server endpoint. This design provides:"]}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Observability"}),": All tool calls go through the API gateway and are logged automatically"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Reusability"}),": The same MCP server can serve multiple agents"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Testability"}),": Tools can be tested independently via HTTP"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Standard protocol"}),": MCP is portable across different agent frameworks"]}),"\n"]})]}),"\n",(0,i.jsxs)(n.p,{children:["Define tools the AI Agent can use with ",(0,i.jsx)(n.code,{children:"@mimik/mcp-kit"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const { McpServer, z } = require('@mimik/mcp-kit');\n\nconst server = new McpServer({\n  name: 'minsight MCP server',\n  version: '1.0.0',\n});\n\n// HTTP request helper using context.http\nfunction requestAction(opt) {\n  return new Promise((resolve, reject) => {\n    global.http.request({\n      url: opt.url,\n      type: opt.method,\n      headers: opt.headers,\n      authorization: opt.authorization,\n      data: opt.jsonBody && JSON.stringify(opt.jsonBody),\n      success: (result) => resolve(result),\n      error: (err) => {\n        if (err instanceof Error) {\n          reject(err);\n        } else {\n          reject(new Error(err.content || err.message));\n        }\n      },\n    });\n  });\n}\n\n// Simple tool: add two numbers\nserver.tool('add', 'Add two numbers', { a: z.number(), b: z.number() }, (args) => Promise.resolve({\n  content: [{ type: 'text', text: String(args.a + args.b) }],\n}));\n\n// Discovery tool: find nearby nodes\nserver.tool('discoverLocal', 'Discover nodes around me', {}, async () => {\n  const { httpPort } = global.context.info;\n  const { INSIGHT_API_KEY } = global.context.env;\n  try {\n    const res = await requestAction({\n      url: `http://127.0.0.1:${httpPort}/mimik-mesh/insight/v1/nodes?type=linkLocal`,\n      headers: { 'Authorization': `Bearer ${INSIGHT_API_KEY}` },\n    });\n\n    return {\n      content: [{ type: 'text', text: res.data }],\n    };\n  } catch (err) {\n    return {\n      content: [{ type: 'text', text: err.message }],\n    };\n  }\n});\n\n// Returns MCP endpoints for the agent to connect to\nfunction getMcpEndpoints() {\n  const { info } = global.context;\n  const { httpPort, apiRoot } = info;\n\n  const mcpEndpoints = [{\n    name: 'minsight mcp',\n    url: `http://127.0.0.1:${httpPort}${apiRoot}/mcp`,\n  }];\n\n  return { mcpEndpoints };\n}\n\nmodule.exports = {\n  tools: server,\n  getMcpEndpoints,\n};\n"})}),"\n",(0,i.jsx)(n.p,{children:"Key components:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"McpServer"}),": Creates an MCP server that handles JSON-RPC protocol"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"requestAction"}),": Helper to make HTTP requests using ",(0,i.jsx)(n.code,{children:"context.http"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"server.tool()"}),": Registers tools with name, description, schema, and handler"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"getMcpEndpoints()"}),": Returns endpoints the agent will connect to"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"schema-helpers",children:"Schema Helpers"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"z"})," object provides schema validation:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// Basic types\nz.string()              // String type\nz.number()              // Number type\nz.boolean()             // Boolean type\n\n// Complex types\nz.enum(['a', 'b', 'c']) // Enumeration\nz.array(z.string())     // Array of strings\nz.object({ key: z.string() })  // Nested object\nz.optional(z.string())  // Optional field\n\n// Modifiers\n.describe('Description') // Add description\n.default(value)          // Set default value (makes field optional)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"agent-orchestration-srcagentjs",children:"Agent Orchestration (src/agent.js)"}),"\n",(0,i.jsxs)(n.p,{children:["The agent uses ",(0,i.jsx)(n.code,{children:"@mimik/agent-kit"})," to orchestrate AI with tools:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const { Agent } = require('@mimik/agent-kit');\n\nconst instructions = 'You are a helpful assistant with access to MCP tools. Use them to answer user questions.';\n\nasync function* run(opt) {\n  const { httpPort } = global.context.info;\n  const { INFERENCE_API_KEY } = global.context.env;\n\n  const agent = new Agent({\n    name: 'MCP Assistant',\n    instructions,\n    httpClient: global.http,\n    mcpEndpoints: opt?.mcpEndpoints,\n    llm: {\n      endpoint: `http://127.0.0.1:${httpPort}/mimik-ai/openai/v1/chat/completions`,\n      apiKey: `Bearer ${INFERENCE_API_KEY}`,\n    }\n  });\n\n  const userMessage = 'find devices around me'; // Add /no_think suffix for Qwen3\n\n  const result = await agent.run(userMessage, {\n    toolApproval: async (toolCalls) => ({\n      stopAfterExecution: false, // Default: false (continue conversation)\n      approvals: toolCalls.map(() => true),\n    }),\n  });\n\n  for await (const event of result) {\n    // Forward relevant events to client\n    if (event.type === 'raw_model_stream_event') {\n      yield event.data.event;\n    } else if (event.type === 'tool_calls_detected') {\n      yield {\n        type: 'tool_calls_start',\n        tool_calls: event.data.toolCalls,\n      };\n    } else if (event.type === 'tool_results') {\n      yield {\n        type: 'tool_calls_complete',\n        results: event.data.results,\n      };\n    } else if (event.type === 'conversation_complete') {\n      yield {\n        type: 'done',\n        final_output: event.data.finalOutput,\n      };\n      break;\n    }\n  }\n}\n\nmodule.exports = { run };\n"})}),"\n",(0,i.jsx)(n.p,{children:"The agent:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Connects to MCP endpoints to discover available tools"}),"\n",(0,i.jsx)(n.li,{children:"Sends user messages to the AI model"}),"\n",(0,i.jsx)(n.li,{children:"Automatically calls tools when the AI decides to use them"}),"\n",(0,i.jsx)(n.li,{children:"Streams events back to the client in real-time"}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Qwen3 and /no_think",type:"tip",children:(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"/no_think"}),' directive is specific to Qwen3 models. Qwen3 supports a "thinking" mode where it reasons through problems step-by-step. Appending ',(0,i.jsx)(n.code,{children:"/no_think"})," to prompts disables this for faster, more direct responses. This is recommended for tool-use scenarios where you want the model to act quickly. If using other models, remove the ",(0,i.jsx)(n.code,{children:"/no_think"})," suffix."]})}),"\n",(0,i.jsx)(n.h4,{id:"streaming-events",children:"Streaming Events"}),"\n",(0,i.jsx)(n.p,{children:"The agent emits these event types:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Event Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"raw_model_stream_event"})}),(0,i.jsx)(n.td,{children:"Raw streaming tokens from the model"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tool_calls_detected"})}),(0,i.jsx)(n.td,{children:"Tools the model wants to call"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tool_results"})}),(0,i.jsx)(n.td,{children:"Results from tool execution"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"conversation_complete"})}),(0,i.jsx)(n.td,{children:"Final result with complete output"})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"advanced-configuration",children:"Advanced Configuration"}),"\n",(0,i.jsx)(n.p,{children:"For more control, you can configure the LLM settings:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const { httpPort } = global.context.info;\nconst { INFERENCE_API_KEY } = global.context.env;\n\nconst agent = new Agent({\n  name: 'MCP Assistant',\n  instructions,\n  httpClient: global.http,\n  mcpEndpoints: opt?.mcpEndpoints,\n  maxIterations: 5,          // Max conversation loops (default: 5)\n  llm: {\n    endpoint: `http://127.0.0.1:${httpPort}/mimik-ai/openai/v1/chat/completions`,\n    apiKey: `Bearer ${INFERENCE_API_KEY}`,\n    model: 'qwen3-1.7b',     // Qwen3 recommended for tool use\n    temperature: 0.1,        // Lower = more deterministic\n    max_tokens: 2048,        // Maximum response length\n    no_think: true           // Qwen3: disable thinking mode for faster responses\n  }\n});\n\n// Optionally initialize explicitly to preload tools\nawait agent.initialize();\n"})}),"\n",(0,i.jsxs)(n.admonition,{title:"Dynamic Port and API Keys",type:"tip",children:[(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"context.info.httpPort"})," to get the port dynamically instead of hardcoding ",(0,i.jsx)(n.code,{children:"8083"}),". Use separate environment variables for each API:"]}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"INFERENCE_API_KEY"}),": For AI Foundation inference API"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"INSIGHT_API_KEY"}),": For Mesh Foundation discovery API"]}),"\n"]})]}),"\n",(0,i.jsx)(n.h2,{id:"step-4-build-the-project",children:"Step 4: Build the Project"}),"\n",(0,i.jsx)(n.p,{children:"Build the mim using webpack:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run build\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This transpiles ES6+ to ES5 (required for the Duktape runtime) and bundles everything into ",(0,i.jsx)(n.code,{children:"build/index.js"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Package as a deployable tar:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run package\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This creates ",(0,i.jsx)(n.code,{children:"deploy/my-agent-1.0.0.tar"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"step-5-deploy-to-mimoe",children:"Step 5: Deploy to mimOE"}),"\n",(0,i.jsx)(n.p,{children:"Deploy using the MCM API. First, get your MCM API key:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cat mimoe-api-key.env\n"})}),"\n",(0,i.jsx)(n.p,{children:"Upload the image:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8083/mcm/v1/images \\\n  -H "Authorization: Bearer $MCM_API_KEY" \\\n  -F "image=@deploy/my-agent-1.0.0.tar"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Deploy the mim:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8083/mcm/v1/mims \\\n  -H "Authorization: Bearer $MCM_API_KEY" \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "name": "my-agent",\n    "image": "my-agent",\n    "env": {\n      "MCM.BASE_API_PATH": "/my-agent/v1",\n      "MCM.API_ALIAS": "true",\n      "INFERENCE_API_KEY": "1234",\n      "INSIGHT_API_KEY": "1234"\n    }\n  }\'\n'})}),"\n",(0,i.jsx)(n.h2,{id:"step-6-test-the-ai-agent",children:"Step 6: Test the AI Agent"}),"\n",(0,i.jsx)(n.h3,{id:"health-check",children:"Health Check"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl http://localhost:8083/api/my-agent/v1/healthcheck\n"})}),"\n",(0,i.jsx)(n.p,{children:"Expected response:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "status": "ok",\n  "info": {\n    "httpPort": 8083,\n    "apiRoot": "/api/my-agent/v1"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"list-mcp-tools",children:"List MCP Tools"}),"\n",(0,i.jsx)(n.p,{children:"Initialize the MCP connection and list available tools:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# Initialize\ncurl -X POST http://localhost:8083/api/my-agent/v1/mcp \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "jsonrpc": "2.0",\n    "id": "init-1",\n    "method": "initialize",\n    "params": {\n      "protocolVersion": "2025-03-26",\n      "capabilities": { "tools": {} },\n      "clientInfo": { "name": "test-client", "version": "1.0.0" }\n    }\n  }\'\n\n# List tools\ncurl -X POST http://localhost:8083/api/my-agent/v1/mcp \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "jsonrpc": "2.0",\n    "id": "list-1",\n    "method": "tools/list"\n  }\'\n'})}),"\n",(0,i.jsx)(n.h3,{id:"call-a-tool-directly",children:"Call a Tool Directly"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8083/api/my-agent/v1/mcp \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "jsonrpc": "2.0",\n    "id": "call-1",\n    "method": "tools/call",\n    "params": {\n      "name": "add",\n      "arguments": { "a": 5, "b": 3 }\n    }\n  }\'\n'})}),"\n",(0,i.jsx)(n.p,{children:"Expected response:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "jsonrpc": "2.0",\n  "id": "call-1",\n  "result": {\n    "content": [{ "type": "text", "text": "8" }]\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"chat-with-the-agent",children:"Chat with the Agent"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"/chat"})," endpoint streams SSE events:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -X POST http://localhost:8083/api/my-agent/v1/chat \\\n  -H \"Content-Type: application/json\" \\\n  -d '{}'\n"})}),"\n",(0,i.jsx)(n.p,{children:"You'll receive streamed events as the agent thinks, calls tools, and generates responses."}),"\n",(0,i.jsx)(n.h2,{id:"step-7-add-custom-tools",children:"Step 7: Add Custom Tools"}),"\n",(0,i.jsxs)(n.p,{children:["Extend the agent by adding your own tools in ",(0,i.jsx)(n.code,{children:"src/tools.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// Tool with optional parameters and defaults\nserver.tool('search', 'Search for items in the database', {\n  query: z.string().describe('Search query'),\n  limit: z.number().default(10).describe('Maximum results to return'),\n  category: z.optional(z.string()).describe('Filter by category')\n}, async (args) => {\n  const { query, limit, category } = args;\n  // Implementation here\n  return {\n    content: [{ type: 'text', text: `Found results for \"${query}\"` }],\n  };\n});\n\n// Tool with enum options\nserver.tool('setOrderType', 'Set the order type', {\n  type: z.enum(['pickup', 'delivery', 'dine-in']).default('pickup').describe('Order type'),\n  priority: z.enum(['low', 'normal', 'high']).default('normal').describe('Priority level')\n}, async (args) => {\n  return {\n    content: [{ type: 'text', text: `Order set to ${args.type} (${args.priority} priority)` }],\n  };\n});\n\n// Tool using persistent storage\nserver.tool('saveNote', 'Save a note to persistent storage', {\n  key: z.string().describe('Note identifier'),\n  value: z.string().describe('Note content')\n}, async (args) => {\n  await global.context.storage.setItem(args.key, args.value);\n  return {\n    content: [{ type: 'text', text: `Saved note \"${args.key}\"` }],\n  };\n});\n\n// Tool that calls an external API\nserver.tool('getWeather', 'Get weather for a city', {\n  city: z.string().describe('City name')\n}, async (args) => {\n  try {\n    const res = await requestAction({\n      url: `https://api.weather.example/v1/current?city=${args.city}`,\n    });\n    return { content: [{ type: 'text', text: res.data }] };\n  } catch (err) {\n    return { content: [{ type: 'text', text: `Error: ${err.message}` }] };\n  }\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"After adding tools, rebuild and redeploy:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run build && npm run package\n# Then redeploy via MCM API\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-8-advanced-security-optional",children:"Step 8: Advanced Security (Optional)"}),"\n",(0,i.jsx)(n.p,{children:"The generated template approves all tool calls. For production, you can add security controls."}),"\n",(0,i.jsx)(n.h3,{id:"tool-whitelisting",children:"Tool Whitelisting"}),"\n",(0,i.jsx)(n.p,{children:"Control which tools are available from each MCP server:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const agent = new Agent({\n  name: 'Secure Assistant',\n  instructions: 'Help users with controlled tool access.',\n  httpClient: global.http,\n  mcpEndpoints: [\n    // Simple endpoint - all tools allowed\n    'http://localhost:3000/mcp',\n\n    // Only allow specific tools (include mode)\n    {\n      url: 'http://localhost:3001/mcp',\n      options: {\n        toolWhitelist: ['readFile', 'listDirectory'],\n        whitelistMode: 'include'\n      }\n    },\n\n    // Block dangerous tools (exclude mode)\n    {\n      url: 'http://localhost:3002/mcp',\n      options: {\n        toolWhitelist: ['deleteFile', 'formatDisk'],\n        whitelistMode: 'exclude'\n      }\n    }\n  ]\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"runtime-tool-approval",children:"Runtime Tool Approval"}),"\n",(0,i.jsxs)(n.p,{children:["Add dynamic approval logic in the ",(0,i.jsx)(n.code,{children:"toolApproval"})," callback:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const result = await agent.run(userMessage, {\n  toolApproval: async (toolCalls) => ({\n    stopAfterExecution: false,\n    approvals: toolCalls.map(tool => {\n      // Block destructive operations\n      if (tool.function.name.includes('delete')) {\n        return { approve: false, reason: 'Destructive operations not allowed' };\n      }\n      // Approve everything else\n      return true;\n    })\n  })\n});\n"})}),"\n",(0,i.jsxs)(n.admonition,{title:"Human-in-the-Loop Approval",type:"tip",children:[(0,i.jsx)(n.p,{children:"For tools requiring human approval, implement a multi-step flow in your API handler:"}),(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"First request"}),": Return ",(0,i.jsx)(n.code,{children:"{ requiresApproval: true, pendingTools: toolCalls }"})," when sensitive tools are detected"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"UI prompts user"}),": Client shows the pending tools and asks for confirmation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Second request"}),": Client re-sends with ",(0,i.jsx)(n.code,{children:"{ approvedTools: [...] }"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Re-run with approvals"}),": Agent runs again, ",(0,i.jsx)(n.code,{children:"toolApproval"})," callback checks against the pre-approved list"]}),"\n"]}),(0,i.jsx)(n.p,{children:"This pattern keeps humans in control of sensitive operations while maintaining the agentic flow."})]}),"\n",(0,i.jsx)(n.h2,{id:"recap-the-four-things-you-implemented",children:"Recap: The Four Things You Implemented"}),"\n",(0,i.jsxs)(n.p,{children:["This tutorial walked you through implementing the four pieces of an AI Agent mim (as explained in ",(0,i.jsx)(n.a,{href:"/webdemo/docs/ai-foundation/development/how-ai-agent-mims-work",children:"How AI Agent mims Work"}),"):"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Config"}),(0,i.jsx)(n.th,{children:"File"}),(0,i.jsx)(n.th,{children:"What You Did"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"API Handler"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"src/index.js"})}),(0,i.jsxs)(n.td,{children:["Set up ",(0,i.jsx)(n.code,{children:"/chat"}),", ",(0,i.jsx)(n.code,{children:"/mcp"}),", ",(0,i.jsx)(n.code,{children:"/healthcheck"})," endpoints with SSE streaming"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Instructions"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"src/agent.js"})}),(0,i.jsx)(n.td,{children:"Defined agent behavior in natural language"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"MCP Endpoints"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"src/tools.js"})}),(0,i.jsxs)(n.td,{children:["Created tools with ",(0,i.jsx)(n.code,{children:"@mimik/mcp-kit"})," and exposed via ",(0,i.jsx)(n.code,{children:"/mcp"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Context Retrieval"})}),(0,i.jsx)(n.td,{children:"(optional)"}),(0,i.jsxs)(n.td,{children:["Use ",(0,i.jsx)(n.code,{children:"mkb"})," or ",(0,i.jsx)(n.code,{children:"edis"})," for RAG and secured data (not covered in this basic tutorial)"]})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"serverless-execution",children:"Serverless Execution"}),"\n",(0,i.jsxs)(n.p,{children:["Mims are stateless. Each request instantiates a fresh execution context. Use ",(0,i.jsx)(n.code,{children:"context.storage"})," for persistence between requests."]}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"build-fails-with-syntax-errors",children:"Build Fails with Syntax Errors"}),"\n",(0,i.jsx)(n.p,{children:"The Duktape runtime only supports ES5. Ensure webpack is transpiling correctly:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Check webpack.config.js targets ES5\nnpm run build -- --mode development\n"})}),"\n",(0,i.jsx)(n.h3,{id:"tool-not-found",children:"Tool Not Found"}),"\n",(0,i.jsx)(n.p,{children:"Ensure the tool is registered before the mim is packaged:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Check ",(0,i.jsx)(n.code,{children:"tools.js"})," exports the server"]}),"\n",(0,i.jsxs)(n.li,{children:["Rebuild: ",(0,i.jsx)(n.code,{children:"npm run build && npm run package"})]}),"\n",(0,i.jsx)(n.li,{children:"Redeploy the mim"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"agent-returns-empty-response",children:"Agent Returns Empty Response"}),"\n",(0,i.jsx)(n.p,{children:"Check that:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["A model is loaded in mimOE (",(0,i.jsx)(n.code,{children:"GET /mimik-ai/openai/v1/models"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"httpClient"})," is passed correctly to the Agent (",(0,i.jsx)(n.code,{children:"global.http"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["MCP endpoints are correctly configured in ",(0,i.jsx)(n.code,{children:"getMcpEndpoints()"})]}),"\n",(0,i.jsxs)(n.li,{children:["The mim is deployed with correct environment variables (",(0,i.jsx)(n.code,{children:"INFERENCE_API_KEY"}),", ",(0,i.jsx)(n.code,{children:"INSIGHT_API_KEY"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"/docs/api/agent-kit",children:"Agent Kit API Reference"})}),": Agent configuration options"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"/docs/api/context",children:"Context API"})}),": Available runtime APIs"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"/docs/mesh-foundation/discovery",children:"Mesh Discovery"})}),": Connect agents across devices"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>r,x:()=>l});var s=t(6540);const i={},o=s.createContext(i);function r(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);